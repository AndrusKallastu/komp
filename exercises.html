<!DOCTYPE html>
<!--player lehelt: https://github.com/surikov/webaudiofont  -->
<html>
  <head>
    <title>Muusikaharjutused</title>
    <meta content="">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1" />
    <style></style>
    
    <script src="https://unpkg.com/vextab/releases/vextab-div.js"></script>    
    <script src='https://surikov.github.io/webaudiofont/npm/dist/WebAudioFontPlayer.js'></script>
    <script src='https://surikov.github.io/webaudiofontdata/sound/0000_JCLive_sf2_file.js'> </script>
	<script src="baseclass.js"></script>
	
	
    <script>
    
    var exercise; 
	
	// all exercises are written as functions that set the title and other necesaary html element, initiate a MusicExercise object and add necessary methods etc
	function exercise1() { // Harjutus 1.2.3 Lisa puuduv helivältus
		// variables
		var hiddenNote = -1, hiddenDuration = -1;
		var answered = false;
		
		// Create or set necessary HTML elements
		document.getElementById("exerciseTitle").innerHTML = "Lisa puuduv helivältus";
		document.getElementById("description").innerHTML = "Antud on teatud taktimõõdus takt, milles on peidetud üks helivältus (noot või paus). Lisa puuduv helivältus (noot või paus) // VÕI: arva ära peidetud vältus."; 
		//TODO: luba ka pause, mitte ainult noodid -  kas vaja?
		document.getElementById("question").innerHTML =	"Mis on peidetud nöödi vältus?";
		var response = document.createElement("select");
		response.id = "response";
		response.innerHTML ='<option value="0" selected>----</option>' +
			'<option value="2">Poolnoot</option>' +
			'<option value="1">Veerandnoot</option>' +
			'<option value="0.5">Kaheksandiknoot</option>' +
			'<option value="0.25">Kuueteistkümnendik</option>';		
		document.getElementById("responseDiv").appendChild(response);
		
		// set necessary methods in exercise
		exercise = new MusicExercise("mainCanvas");
		exercise.attempts = 0; exercise.score = 0;
		document.getElementById("attempts").innerHTML = "0";
		document.getElementById("score").innerHTML = "0";
		
		
		exercise.generate = function() {
		
			var totalDuration = 0, barLength = 4; // barLength in beats
			var durations;
			
			do {  // create a rhythm that equals to barLength
				totalDuration = 0;
				durations = [];
			var allowedDurations = [2, 1, 0.5, 0.25]; 
				while (totalDuration<=barLength) {                                
					var duration = allowedDurations[Math.floor(Math.random()*allowedDurations.length)];
					
					if ((totalDuration + duration)>barLength) {
						break;
					}
					//console.log("Duration: ", duration);
					durations.push(duration);
					totalDuration += duration;
				}
			} while (totalDuration!=barLength);  // bad code, avoid loop, rather add up random notes and fill the rest with suitable values
			console.log("Generted durations:", durations); // BETTER: create separate function for creating rhytms for a bar
			
			
			// create VexFlow string of notes
			hiddenNote = Math.floor(Math.random()*durations.length);
			hiddenDuration = durations[hiddenNote];
			console.log("Hide the note (index), with duration", hiddenNote, hiddenDuration);
			var parseString = "";
			for (let duration of durations) {
				var flexDuration = (4/duration).toString();
				//console.log(_duration,flexDuration);
				parseString += " :"+flexDuration + " B/4 ";
				// better probably artist.addNote(), but it is unclear how to use it
				
			}
			console.log("Generated notes: ", parseString);
			exercise.notes = parseString;
			answered = false; // necessary to set a flag to check if the quetion has answered already in checkResponse
		
		}
		
		exercise.hide = function() {
			
			var notes = exercise.getNotes(0); // millegipärast 0???
			if (hiddenNote>notes.length) {
				console.log("There is not that many notes!", hiddenNote)
				return;
			}
			var note = exercise.artist.staves[0].note_notes[hiddenNote];
			var context = exercise.renderer.getContext();
			context.setFillStyle("darkgreen");
			context.fillRect(note.getAbsoluteX()-10, note.stave.getYForTopText()-10, note.width+20, note.stave.height+10);
		}
		
		exercise.generate();		
		exercise.draw();
		exercise.hide();
		
		document.getElementById("renewButton").onclick = function() {
			exercise.generate(); 
			exercise.draw();
			exercise.hide();
		}
		
		exercise.checkResponse = function() {
			//TODO: kontrolli, kas uuendatud, muidu tõstab ainult skoori...
			if (answered) {
				alert('Sa oled juba vastanud. Vajuta "Uuenda"');
				return;
			}
			exercise.attempts += 1;
			var feedback = "";
			if (parseFloat(document.getElementById("response").value)===hiddenDuration) {
				feedback = "Õige!"
				exercise.score += 1;
			} else {
				var durationString = "";
				switch (hiddenDuration) {
					case 2:  durationString = "Poolnoot"; break;
					case 1:  durationString = "Veerandnoot"; break;
					case 0.5:  durationString = "Kaheksandiknoot"; break;
					case 0.25:  durationString = "Kuueteistkümnendik"; break;
					default: durationString = "?"; break;
				}
				feedback = "Vale! Õige oli: "+durationString; // TODO 0.25-> Kuueteistkümnendik jne
			}
			
			
			document.getElementById("attempts").innerHTML = exercise.attempts;
			document.getElementById("score").innerHTML = exercise.score;
			document.getElementById("feedback").innerHTML = feedback; 
			exercise.draw(); // redraw without rectangle
			answered = true;
		
		}
		
	
	}
    
    

    
	window.onload = function() {
		exercise1();
		//exercise = new MusicExercise("mainCanvas");
		//exercise.draw();
	}


    
    </script>

    </head>
    
	<body>
	<h1 id="title">MUUSIKA KOMPOSITSIOONIÕPETUS. Harjutused</h1>
	<h2 id="exerciseTitle">Harjutuse nimi</h2>
	<br>
	<p id="description">Ülesande kirjeldus.</p>
	<br>
	<button id="playButton" onclick="exercise.play();">Mängi</button><br>
	<canvas id="mainCanvas"></canvas>
	<br>
	<button id = "renewButton" onclick='console.log("Set the actions in your exercise definition.")'>Uuenda</button><br>
	<br>
	<span id="question">Küsimus</span>
	
	<span id="responseDiv"></span>
	<button id="replyButton" onclick="exercise.checkResponse()">Vasta</button>
	
	<p id="feedback"></p>
	Katseid: <label id="attempts">0</label>. Neist õigeid vastuseid: <label id="score">0</label> 
	<button id="resetButton" onclick='exercise.attempts=0;exercise.score=0;attempts.innerHTML="0"; score.innerHTML = "0" '>Nulli</button>
	<br>
	

	</body>
</html>
